<?php
defined('INI_TXTCMS') or exit(); $config=require TEMP_PATH.'config.php'; $URL_ROUTE_RULES=array( '/^sitemap\.xml$/'=>'home/'.config('DEFAULT_MODULE').'/sitemap?type=xml', '/^uploads\/images\/(\d+)\.jpg$/'=>'home/'.config('DEFAULT_MODULE').'/images?id=:1', '/^uploads\/images\/logo\.png\??(.*)$/'=>'home/'.config('DEFAULT_MODULE').'/logo?:1', '/^static\/js\/system\/(.*)\.xbwjs\??(.*)$/'=>'admin/login/sysjs?:1', ); $arctypeconf_file=TEMP_PATH.'arctype_config.php'; $domainconf_file=TEMP_PATH.'domaindb_config.php'; $host=$_SERVER['HTTP_HOST']; if (substr($_SERVER['QUERY_STRING'], 0, 6) != 'admin-' && !preg_match('~/js/system/~',$_SERVER['QUERY_STRING']) && is_file($domainconf_file)){$domainConfArr=require $domainconf_file; $arctypeArr=require $arctypeconf_file; if($domainConfArr){$urlrules=array(); foreach($domainConfArr as $k=>$vo){$domain_root=$k; if(isset($domainConfArr[$host]) || isset($domainConfArr['www.'.$host])){$domain_root=$host; $vo=$domainConfArr[$host]; } if($host==$domain_root || preg_match('~\.'.preg_quote($domain_root).'$~i',$host)){$GLOBALS['domain_root']=$domain_root; $cids=explode(',',$vo['cid']); foreach($cids as $kk=>$vv){if(!isset($arctypeArr[$vv])) unset($cids[$kk]); } if(!$cids){send_http_status(404); exit('模型不存在'); } if(count($cids)==1){if(!isset($arctypeArr[$vo['cid']])){send_http_status(404); exit('模型不存在.'); } $domain_cid=$vo['cid']; }else{$domain_cids_file=DATA_PATH.'domain/'.$vo['dirname'].'_typecids.txt'; $domain_cid=''; $cidarr=array(); if(is_file($domain_cids_file)){$cidarr=unserialize(file_get_contents($domain_cids_file)); isset($cidarr[$domain_root]) && $domain_cid=$cidarr[$domain_root]; } if($domain_cid && !isset($arctypeArr[$domain_cid])){$domain_cid=''; } if(!$domain_cid){$domain_file=DATA_PATH.'domain/'.$vo['dirname'].'/domain.txt'; $domain_arr=file($domain_file); if(count($domain_arr)>count($cids)){$bfb=ceil(count($domain_arr)/count($cids)); $oldcids=$cids; for($ii=0;$ii<$bfb;$ii++){$cids=array_merge($oldcids,$cids); } } $cids=array_slice($cids,0,count($domain_arr)); $domain_arr=array_map('trim',$domain_arr); $cidarr2=array_combine($domain_arr,$cids); if(!$cidarr){$cidarr=$cidarr2; }else{$cidarr=array_merge($cidarr2,$cidarr); } $domain_cid=$cidarr[$domain_root]; writefile($domain_cids_file,serialize($cidarr)); } } $GLOBALS['domain_id']=$vo['id']; $GLOBALS['domain_cid']=$domain_cid; $urlrules=unserialize($arctypeArr[$domain_cid]['urlrules']); $GLOBALS['arctype_config']=$arctypeArr[$domain_cid]; $GLOBALS['arctype_config']['urlrules']=$urlrules; $GLOBALS['domain_dirname']=$vo['dirname']; $GLOBALS['arctype_dirname']=$GLOBALS['arctype_config']['dirname']; break; } } if($urlrules){foreach($urlrules as $k=>$vo){list($method)=explode('.',$vo['tplfile']); $rulesArr=explode(',',$vo['rules']); foreach($rulesArr as $kk=>$vv){$rules=$vv; $：2=''; preg_match_all('~\{([^\}\d]+)(\d*)\}~',$rules,$match); foreach($match[0] as $kk=>$vv){$num=$match[2][$kk]; $num=max($num,1); $strtype=$match[1][$kk]; if($strtype=='日期'){$num=8; }else if($strtype=='年'){$num=4; }else if($strtype=='月' || $strtype=='日' || $strtype=='时' || $strtype=='分' || $strtype=='秒'){$num=2; } if($vv=='{id}'){$rules=str_replace($vv,'([\\w]+)',$rules); $：2='&aid=:2'; }else{$rules=str_replace($vv,'[\\w]{'.$num.'}',$rules); } } $rules=str_replace('.','\.',$rules); $rules=str_replace('/','\/',$rules); $rules='/^('.$rules.')$/'; $URL_ROUTE_RULES[$rules]='home/'.config('DEFAULT_MODULE').'/'.$method.'?id=:1'.$：2; } } } } } if(!config('web_debug')){config('LOG_RECORD',false); } $array=array( 'txtfile'=>array('robot_redirect_data'=>'蜘蛛强引外链'), 'txtdir'=>array('title'=>'标题','webname'=>'网站名称','content'=>'文章句子','body'=>'整篇文章','pic'=>'图片链接','video'=>'视频链接','diy'=>'自定义','typename'=>'栏目'), 'txtdir2'=>array('keywords'=>'关键词','link'=>'外链'), 'TMPL_ACTION_ERROR'=>APP_PATH.'static/tips/_jump.html', 'TMPL_ACTION_SUCCESS'=>APP_PATH.'static/tips/_jump.html', 'DEFAULT_GROUP'=>'home', 'APP_GROUP_LIST'=>'home,admin,plus', 'DB_HASH_LIST'=>'', 'DEFAULT_THEME'=>$config['web_default_theme'], 'URL_MODEL'=>$config['web_url_model'], 'URL_PATH_DEPR'=>$config['web_path_depr'], 'URL_PATH_SUFFIX'=>$config['web_path_suffix'], 'HTML_CACHE'=>$config['web_caching'], 'URL_ROUTER_ON'=>true, 'AUTOLOAD_ENCODE'=>true, 'TMPL_COMPILE_CHECK'=>(($config['web_debug'] || APP_DEBUG)?true:false), 'ADMIN_ACTION_LOG'=>true, 'HOME_SPAGE_LIST_NUM'=>5, 'HOME_SPAGE_LIST_ADDV'=>1, 'HOME_SPAGE_CONTENT_NUM'=>0, 'COLLECT_LIST_CACHE_TOUCHTIME'=>60*5, 'COLLECT_CONTENT_CACHE_TOUCHTIME'=>60*60, 'URL_ROUTE_RULES'=>$URL_ROUTE_RULES, 'ROBOT_LIST'=>array( "Baiduspider-render"=>"百度渲染", "Baiduspider"=>"百度", "googlebot"=>"Google", "360Spider"=>"360蜘蛛", "HaoSouSpider"=>"好搜蜘蛛", "Yisouspider"=>"神马", "sogou"=>"搜狗", "sosospider"=>"腾讯soso", "Sosoimagespider"=>"soso图片", "yahoo"=>"雅虎", "Exabot"=>"Exabot", "MSNBot"=>"微软bing", "ia_archiver"=>"Alexa", "sohu"=>"搜狐", "sqworm"=>"AOL", "yodaoBot"=>"有道", "iaskspider"=>"新浪爱问", "Scooter"=>"Altavista", "Lycos_Spider"=>"Lycos", "FAST-WebCrawler"=>"Alltheweb", "Slurp"=>"INKTOMI", "Gigabot"=>"gigablast.com", "BSpider"=>"日本蜘蛛", ), ); return array_merge($config,$array);